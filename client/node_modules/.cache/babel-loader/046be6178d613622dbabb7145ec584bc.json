{"ast":null,"code":"import _objectWithoutProperties from \"/home/efimenko/\\u0420\\u0430\\u0431\\u043E\\u0447\\u0438\\u0439 \\u0441\\u0442\\u043E\\u043B/alive-empire-game/client/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties\";\nimport _toConsumableArray from \"/home/efimenko/\\u0420\\u0430\\u0431\\u043E\\u0447\\u0438\\u0439 \\u0441\\u0442\\u043E\\u043B/alive-empire-game/client/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";\nimport _objectSpread from \"/home/efimenko/\\u0420\\u0430\\u0431\\u043E\\u0447\\u0438\\u0439 \\u0441\\u0442\\u043E\\u043B/alive-empire-game/client/node_modules/@babel/runtime/helpers/esm/objectSpread\";\nvar initConfig = {\n  // может стоит делать его муртвым чтобы меньше рендерить?\n  alive: function alive(x) {\n    return x >= 1;\n  },\n  rules: function rules(x) {\n    return 0;\n  },\n  name: 'init'\n};\n\nvar argmax = function argmax(array) {\n  return array.length ? array.map(function (x, i) {\n    return [x, i];\n  }).reduce(function (r, a) {\n    return a[0] > r[0] ? a : r;\n  })[1] : -1;\n};\n\nvar Engine = function Engine(canvas) {\n  var cellSize = 10;\n  var shadowSize = 20;\n  var w = Math.floor(canvas.width / cellSize);\n  var h = Math.floor(canvas.height / cellSize);\n\n  var _ctx = canvas.getContext('2d');\n\n  var configs = [];\n\n  var _alive;\n\n  var _rules;\n\n  var count = 0;\n  var _currentLaw = 'init';\n  var statistics = {};\n  var loot = [];\n  var lootImg = '';\n  var _power = 0;\n\n  var onMouseCb = function onMouseCb(x) {\n    return x;\n  };\n\n  var onEnemyMouse = function onEnemyMouse(x) {\n    return x;\n  }; //server\n\n\n  var incPower = function incPower() {\n    return _power += 100;\n  };\n\n  var decPower = function decPower() {\n    return _power > 0 ? _power-- : 0;\n  }; //\n  //client\n\n\n  var setLoot = function setLoot(_ref) {\n    var img = _ref.img,\n        size = _ref.size;\n    lootImg = img;\n  };\n\n  var addConfig = function addConfig(config) {\n    configs[config.name] = _objectSpread({}, config, {\n      id: count++,\n      count: 0\n    });\n  };\n\n  var setConfig = function setConfig(name) {\n    var _configs$name = configs[name],\n        alive = _configs$name.alive,\n        rules = _configs$name.rules;\n    _alive = alive;\n    _rules = rules;\n    _currentLaw = name;\n  };\n\n  addConfig(initConfig);\n  setConfig(_currentLaw); //server\n\n  var lootSpawn = function lootSpawn() {\n    var time = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 1000;\n\n    var spawn = function spawn() {\n      var x = Math.random() * w * cellSize;\n      var y = Math.random() * h * cellSize;\n      loot.push({\n        x: x,\n        y: y\n      });\n      lootSpawn(time);\n    };\n\n    setTimeout(spawn, Math.random() * time);\n  };\n\n  var drawLoot = function drawLoot() {\n    loot.forEach(function (_ref2) {\n      var x = _ref2.x,\n          y = _ref2.y;\n\n      _ctx.drawImage(lootImg, x - 150, y - 80);\n    });\n  }; //server\n\n\n  var intersection = function intersection(x, y) {\n    var epsil = 50;\n    loot = loot.filter(function (l) {\n      var cond = Math.abs(l.x - x) + Math.abs(l.y - y) > epsil;\n      if (!cond) incPower();\n      return cond;\n    });\n  };\n\n  var drawing = function drawing() {\n    if (_power > 0) {\n      var _cords = cords,\n          x = _cords.x,\n          y = _cords.y;\n      world[x + y * w].setState(1);\n      world[x + y * w].setLaw(_currentLaw);\n      decPower();\n      onMouseCb(x, y);\n    }\n  };\n\n  var enemyDrawing = function enemyDrawing(config) {\n    var x = config.x,\n        y = config.y,\n        race = config.race;\n    world[x + y * w].setState(1);\n    world[x + y * w].setLaw(race);\n  };\n\n  var start = function start() {\n    lootSpawn(20000);\n  };\n\n  var init = function init() {\n    // удалить интервал\n    canvas.addEventListener('mousemove', function (event) {\n      var _getCords = getCords(event),\n          x = _getCords.x,\n          y = _getCords.y;\n\n      cords = {\n        x: Math.floor(x / cellSize),\n        y: Math.floor(y / cellSize)\n      };\n      intersection(x, y);\n    });\n    canvas.addEventListener('mousedown', function (event) {\n      var _getCords2 = getCords(event),\n          x = _getCords2.x,\n          y = _getCords2.y;\n\n      drawing();\n      canvas.addEventListener('mousemove', drawing);\n    });\n    canvas.addEventListener('mouseup', function () {\n      canvas.removeEventListener('mousemove', drawing);\n    });\n  };\n\n  init();\n\n  var Cell = function Cell(state) {\n    var law = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 'init';\n    return function (index) {\n      var j = Math.floor(index / w);\n      var i = index % w;\n      var _law = law;\n\n      var c = function c(i, j) {\n        var _i = i < 0 ? w + i : i < w ? i : w - i;\n\n        var _j = j < 0 ? h + j : j < h ? j : h - j;\n\n        return _i + _j * w;\n      };\n\n      var _state = state;\n\n      var setState = function setState(s) {\n        return _state = s;\n      };\n\n      var getState = function getState() {\n        return _state;\n      };\n\n      var setLaw = function setLaw(l) {\n        return _law = l;\n      };\n\n      var getLaw = function getLaw() {\n        return _law;\n      };\n\n      var siblings = function siblings() {\n        return [world[c(i - 1, j - 1)], world[c(i - 1, j)], world[c(i - 1, j + 1)], world[c(i, j - 1)], world[c(i, j + 1)], world[c(i + 1, j - 1)], world[c(i + 1, j)], world[c(i + 1, j + 1)]];\n      };\n\n      return {\n        getState: getState,\n        siblings: siblings,\n        index: index,\n        getLaw: getLaw,\n        setState: setState,\n        setLaw: setLaw\n      };\n    };\n  };\n\n  var world = _toConsumableArray(Array(w * h).keys()).map(Cell(0));\n\n  var cords = {};\n\n  var getCords = function getCords(event) {\n    return {\n      x: event.pageX - canvas.offsetLeft,\n      y: event.pageY - canvas.offsetTop\n    };\n  };\n\n  var Law = function Law(sibl) {\n    var m = {};\n    sibl.forEach(function (sib) {\n      return _alive(sib.getState()) ? m[sib.getLaw()]++ : 0;\n    });\n    var law = 'init';\n\n    var init = m.init,\n        res = _objectWithoutProperties(m, [\"init\"]);\n\n    var keys = Object.keys(res);\n    var values = Object.values(res);\n    var id = argmax(values);\n    return id < 0 ? 'init' : keys[id];\n  };\n\n  var next = function next(cell) {\n    var prev = cell.getState();\n    var siblings = cell.siblings();\n    var law = Law(siblings);\n    setConfig(law);\n    if (_alive(cell.getState())) configs[law][count]++;\n    var res = siblings.reduce(function (a, x) {\n      return a + x.getState();\n    }, 0);\n    return Cell(_rules(prev, res, _alive), law)(cell.index);\n  };\n\n  var epoch = function epoch() {\n    for (var el in configs) {\n      configs[el][count] = 0;\n    }\n\n    world = world.map(next);\n  };\n\n  var use = function use(name) {\n    setConfig(name);\n  };\n\n  var draw = function draw(i, j) {\n    var cell = world[i + j * w];\n    var id = cell.getLaw();\n    var image = configs[id].image;\n    if (image) _ctx.drawImage(image, i * cellSize, j * cellSize);\n  };\n\n  var draw1 = function draw1(i, j) {\n    var cell = world[i + j * w];\n    var id = cell.getLaw();\n    var shadow = configs[id].shadow;\n\n    if (shadow) {\n      _ctx.beginPath();\n\n      _ctx.fillStyle = \"rgba(\".concat(shadow.r, \",\").concat(shadow.g, \",\").concat(shadow.b, \",0.13)\");\n\n      _ctx.arc((i + 0.8) * cellSize, (j + 0.8) * cellSize, shadowSize, 0, 2 * Math.PI);\n\n      _ctx.fill();\n    }\n  };\n\n  var paint = function paint() {\n    _ctx.clearRect(0, 0, canvas.width, canvas.height);\n\n    for (var i = 0; i < w; ++i) {\n      for (var j = 0; j < h; ++j) {\n        if (_alive(world[i + j * w].getState())) {\n          draw(i, j);\n        }\n      }\n    }\n  };\n\n  var render = function render() {\n    epoch();\n\n    _ctx.clearRect(0, 0, canvas.width, canvas.height);\n\n    for (var i = 0; i < w; ++i) {\n      for (var j = 0; j < h; ++j) {\n        if (_alive(world[i + j * w].getState())) {\n          draw(i, j);\n        } else {\n          draw1(i, j);\n        }\n      }\n    }\n\n    drawLoot();\n  };\n\n  var set = function set(world) {\n    return world = world;\n  };\n\n  var getStatistics = function getStatistics(name) {\n    return configs[name][count];\n  };\n\n  var getPower = function getPower() {\n    return _power;\n  };\n\n  var initPower = function initPower(val) {\n    return _power = val;\n  };\n\n  var onMouse = function onMouse(cb) {\n    return onMouseCb = cb;\n  };\n\n  return {\n    render: render,\n    addConfig: addConfig,\n    use: use,\n    getStatistics: getStatistics,\n    setLoot: setLoot,\n    getPower: getPower,\n    initPower: initPower,\n    start: start,\n    onMouse: onMouse,\n    enemyDrawing: enemyDrawing,\n    paint: paint,\n    set: set\n  };\n};\n\nexport default Engine;","map":{"version":3,"sources":["/home/efimenko/Рабочий стол/alive-empire-game/client/src/engine/index.js"],"names":["initConfig","alive","x","rules","name","argmax","array","length","map","i","reduce","r","a","Engine","canvas","cellSize","shadowSize","w","Math","floor","width","h","height","_ctx","getContext","configs","_alive","_rules","count","_currentLaw","statistics","loot","lootImg","_power","onMouseCb","onEnemyMouse","incPower","decPower","setLoot","img","size","addConfig","config","id","setConfig","lootSpawn","time","spawn","random","y","push","setTimeout","drawLoot","forEach","drawImage","intersection","epsil","filter","l","cond","abs","drawing","cords","world","setState","setLaw","enemyDrawing","race","start","init","addEventListener","event","getCords","removeEventListener","Cell","state","law","index","j","_law","c","_i","_j","_state","s","getState","getLaw","siblings","Array","keys","pageX","offsetLeft","pageY","offsetTop","Law","sibl","m","sib","res","Object","values","next","cell","prev","epoch","el","use","draw","image","draw1","shadow","beginPath","fillStyle","g","b","arc","PI","fill","paint","clearRect","render","set","getStatistics","getPower","initPower","val","onMouse","cb"],"mappings":"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","sourcesContent":["\nconst initConfig = {\n\t// может стоит делать его муртвым чтобы меньше рендерить?\n\talive: x => x >= 1,\n\trules: x => 0,\n\tname: 'init'\n}\n\nconst argmax = array => {\n\treturn array.length ? array.map((x, i) => [x, i]).reduce((r, a) => (a[0] > r[0] ? a : r))[1]: -1\n}\n\n\nconst Engine = (canvas) => {\n\tconst cellSize = 10;\n\tconst shadowSize = 20;\n\tconst w = Math.floor(canvas.width / cellSize)\n\tconst h = Math.floor(canvas.height / cellSize)\n\tconst _ctx = canvas.getContext('2d')\n\tconst configs = []\n\tlet _alive;\n\tlet _rules;\n\tlet count = 0\n\tlet _currentLaw = 'init'\n\tlet statistics = {}\n\tlet loot = []\n\tlet lootImg = ''\n\tlet _power = 0\n\tlet onMouseCb = (x) => x \n\tlet onEnemyMouse = (x) => x\n\n\n\t//server\n\tconst incPower = () => _power += 100\n\tconst decPower = () => _power > 0 ? _power-- : 0\n\t//\n\t//client\n\tconst setLoot = ({img, size}) => {\n\t\tlootImg = img\n\t}\n\tconst addConfig = (config) => {\n\t\tconfigs[config.name] = { ...config, id: count++, count:0 }\n\t}\n\tconst setConfig = (name) => {\n\t\tconst { alive, rules} = configs[name]\n\t\t_alive = alive;\n\t\t_rules = rules\n\t\t_currentLaw = name\n\t}\n\n\taddConfig(initConfig)\n\tsetConfig(_currentLaw)\n\n\t//server\n\tconst lootSpawn = (time = 1000) => {\n\t\tconst spawn = () => {\n\t\t\tconst x = Math.random() * w * cellSize\n\t\t\tconst y = Math.random() * h * cellSize\n\t\t\t\tloot.push({x:x, y:y})\n\t\t\t\tlootSpawn(time)\n\t\t}\n\t\tsetTimeout(spawn, Math.random() * time)\n\t}\n\n\tconst drawLoot = () => {\n\t\tloot.forEach(({x,y}) => {  \n\t\t\t\t_ctx.drawImage(lootImg, x - 150, y - 80)\n\t\t})\n\t}\n\n\t//server\n\tconst intersection = (x, y) => {\n\t\tconst epsil = 50;\n\t\tloot = loot.filter(l => {\n\t\t\tconst cond = (Math.abs(l.x - x) + Math.abs(l.y - y)) > epsil\n\t\t\tif (!cond) incPower()\n\t\t\treturn cond\n\t\t})\n\t}\n\tconst drawing = () => {\n\t\tif (_power > 0){\n\t\t\tconst {x ,y} = cords;\n\t\t\tworld[x + y * w].setState(1)\n\t\t\tworld[x + y * w].setLaw(_currentLaw)\n\t\t\tdecPower()\n\t\t\tonMouseCb(x, y)\n\t\t}\n\t}\n\n\tconst enemyDrawing = (config) => {\n\t\t\tlet { x, y, race } = config\n\t\t\tworld[x + y * w].setState(1)\n\t\t\tworld[x + y * w].setLaw(race)\n\t}\n\n\tconst start = () => {\n\t\tlootSpawn(20000)\n\t}\n\n\tconst init = () => {\n\t\t// удалить интервал\n\t\tcanvas.addEventListener('mousemove',(event) =>{\n\t\t\tconst {x, y} = getCords(event)\n\t\t\tcords = {x: Math.floor(x / cellSize), y: Math.floor(y / cellSize)}\n\t\t\tintersection(x, y)\n\t\t});\n\t\tcanvas.addEventListener('mousedown',(event) =>{\n\t\t\tconst { x, y } = getCords(event)\n\t\t\tdrawing()\n\t\t\tcanvas.addEventListener('mousemove', drawing);\n\t\t});\n\t\tcanvas.addEventListener('mouseup', () => {\n\t\t\tcanvas.removeEventListener('mousemove',drawing);\n\t\t});\n\t}\n\tinit()\n\n\tconst Cell = (state, law = 'init') => (index) => {\n\t\tconst j = Math.floor(index / w)\n\t\tconst i = index % w\n\t\tlet _law = law;\n\t\tconst c = (i, j) => {\n\t\t\tconst _i = i < 0 ? w + i: i < w ? i : w - i\n\t\t\tconst _j = j < 0 ? h + j: j < h ? j : h - j\n\t\t\treturn _i + _j * w\n\t\t}\n\t\tlet _state = state;\n\t\tconst setState = (s) => _state = s\n\t\tconst getState = () => _state\n\t\tconst setLaw = (l) => _law = l \n\t\tconst getLaw = () => _law\n\t\tconst siblings = () => [\n\t\t\tworld[c(i - 1, j - 1)],\n\t\t\tworld[c(i - 1, j)],\n\t\t\tworld[c(i - 1, j + 1)],\n\t\t\tworld[c(i, j - 1)],\n\t\t\tworld[c(i, j + 1)],\n\t\t\tworld[c(i + 1, j - 1)],\n\t\t\tworld[c(i + 1, j)],\n\t\t\tworld[c(i + 1, j + 1)]\n\t\t] \n\t\treturn {\n\t\t\tgetState,\n\t\t\tsiblings,\n\t\t\tindex,\n\t\t\tgetLaw,\n\t\t\tsetState,\n\t\t\tsetLaw\n\t\t}\n\t}\n\tlet world = [...Array(w * h).keys()].map(Cell(0))\n\tlet cords = {}\n\t\n\tconst getCords = event => {\n\t\treturn {\n\t\t\tx:event.pageX - canvas.offsetLeft,\n\t\t\ty:event.pageY - canvas.offsetTop\n\t\t}\n\t}\n\tconst Law = sibl => {\n\t\tconst m = {}\n\t\tsibl.forEach(sib => _alive(sib.getState()) ?  m[sib.getLaw()]++: 0)\n\t\tlet law = 'init'\n\t\tconst {init, ...res} = m\n\t\tconst keys = Object.keys(res)\n\t\tconst values = Object.values(res)\n\t\tconst id = argmax(values)\n\t\treturn id < 0 ? 'init': keys[id]\n\t}\n\n\tconst next = (cell) => {\n\t\tconst prev = cell.getState()\n\t\tconst siblings = cell.siblings()\n\t\tconst law = Law(siblings)\n\t\tsetConfig(law)\n\t\tif (_alive(cell.getState())) configs[law][count]++\n\t\tconst res = siblings.reduce((a, x) => a + x.getState(), 0)\n\t\treturn Cell(_rules(prev, res, _alive), law)(cell.index)\n\t}\n\n\tconst epoch = () => {\n\t\tfor (let el in configs) {\n\t\t\tconfigs[el][count] = 0\n\t\t}\n\t\tworld = world.map(next)\n\t}\n\tconst use = name => {\n\t\tsetConfig(name)\n\t}\n\n\tconst draw = (i, j) => {\n\t\tconst cell = world[i + j * w]\n\t\tconst id = cell.getLaw()\n\t\tconst image = configs[id].image\n\t\tif (image) _ctx.drawImage(image, i * cellSize, j * cellSize)\t\n\t}\n\tconst draw1 = (i, j) => {\n\t\tconst cell = world[i + j * w]\n\t\tconst id = cell.getLaw()\n\t\tconst shadow = configs[id].shadow\n\t\tif (shadow){\n\t\t\t_ctx.beginPath()\n\t\t\t_ctx.fillStyle = `rgba(${shadow.r},${shadow.g},${shadow.b},0.13)`\n\t\t\t_ctx.arc((i + 0.8)*cellSize, (j + 0.8)*cellSize, shadowSize, 0, 2*Math.PI)\n\t\t\t_ctx.fill()\n\t\t}\t\n\t}\n\n\tconst paint = () => {\n\t\t_ctx.clearRect(0, 0, canvas.width, canvas.height)\n\t\tfor (let i = 0; i < w; ++i){\n\t\t\tfor (let j = 0; j < h; ++j){\n\t\t\t\t\tif (_alive(world[i + j*w].getState())) {\n\t\t\t\t\t\tdraw(i,j)\n\t\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tconst render = () =>  {\n\t\tepoch()\n\t\t_ctx.clearRect(0, 0, canvas.width, canvas.height)\n\t\tfor (let i = 0; i < w; ++i){\n\t\t\tfor (let j = 0; j < h; ++j){\n\t\t\t\tif (_alive(world[i + j*w].getState())) {\n\t\t\t\t\tdraw(i,j)\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\tdraw1(i,j)\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tdrawLoot()\n\t}\n\tconst set = (world) => world = world\n\tconst getStatistics = (name) => configs[name][count]\n\tconst getPower = () => _power\n\tconst initPower = (val) => _power = val \n\tconst onMouse = (cb) =>  onMouseCb = cb\n\treturn {\n\t\trender,\n\t\taddConfig,\n\t\tuse,\n\t\tgetStatistics,\n\t\tsetLoot,\n\t\tgetPower,\n\t\tinitPower,\n\t\tstart,\n\t\tonMouse,\n\t\tenemyDrawing,\n\t\tpaint,\n\t\tset\n\t}\n}\n\n\n\n\nexport default Engine\n\n"]},"metadata":{},"sourceType":"module"}